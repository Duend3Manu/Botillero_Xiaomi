"use strict";

const externalService = require('../../services/external.service');
const messagingService = require('../../services/messaging.service');

module.exports = {
    name: 'bencina',
    aliases: ['bencinas', 'gasolina'],
    description: 'Busca los precios de la bencina en una comuna espec√≠fica.',
    
    async execute({ client, message, args }) {
        const comuna = args.join(' '); // Une todos los argumentos por si la comuna tiene espacios (ej: "lo prado")

        if (!comuna) {
            await message.reply("Por favor, dime en qu√© comuna quieres buscar. Ejemplo: `!bencina santiago`");
            return;
        }

        try {
            // --- MEJORA DE EXPERIENCIA DE USUARIO ---
            // Se env√≠a una reacci√≥n y un mensaje de texto inmediato para gestionar la espera.
            messagingService.sendLoadingMessage(message);
            await message.reply(`Buscando precios para *${comuna}*... El servicio externo puede demorar unos segundos, ¬°gracias por la paciencia! ‚åõ`);

            // Esta es la l√≠nea que puede demorar hasta 6 segundos o m√°s.
            const bencinaData = await externalService.getBencinaData(comuna);

            // Intenta convertir la respuesta a JSON para ver si es un error del script de Python
            try {
                const errorResponse = JSON.parse(bencinaData);
                if (errorResponse && errorResponse.error) {
                    // Si es un error conocido (como el timeout), manda un mensaje amigable
                    console.error("Error desde el script de Python (bencina.py):", errorResponse.error);
                    await message.reply("Lo siento, el servicio de Bencina en L√≠nea no est√° respondiendo en este momento. üò•\n\nPor favor, intenta de nuevo m√°s tarde.");
                } else {
                    // Si es JSON pero no tiene la clave 'error', lo env√≠a tal cual
                    await message.reply(bencinaData);
                }
            } catch (e) {
                // Si no se puede parsear como JSON, significa que es una respuesta exitosa (texto plano)
                await message.reply(bencinaData);
            }

        } catch (error) {
            console.error('Error en el comando !bencina:', error);
            await message.reply('‚ùå Hubo un problema al buscar la informaci√≥n. Intenta de nuevo.');
        }
    }
};
